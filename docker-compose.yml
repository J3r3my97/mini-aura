version: '3.8'

services:
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    ports:
      - "8001:8080"
    environment:
      - PROJECT_ID=mini-aura
      - REGION=us-central1
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      # Mount GCP credentials
      - ~/.config/gcloud/application_default_credentials.json:/app/credentials/service-account.json:ro
      # Mount code for hot reload (optional)
      # - ./worker:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --reload

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "8000:8080"
    environment:
      - PROJECT_ID=mini-aura
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ~/.config/gcloud/application_default_credentials.json:/app/credentials/service-account.json:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload
